---
title: "export_shinyapps"
author: "Kelli Feeser"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(shinylive)
```


# Render index.html (main page)

ust knit `export_shinyapps.Rmd` and `docs/index.html` will be updated with the current build of the `main_page` app.

```{r export-main-page, message=T, warning=T, eval=F}
# Export main_page app to be the site homepage (docs/index.html) - will overwrite previous file
library(shinylive)

shinylive::export(
  appdir    = "exported_shinyapps/main_page", # relative to docs/
  destdir   = ".",                            # write to docs/ (current dir)
  subdir    = NULL,   # write directly into docs/, not subfolder → index.html
  assets_dir = "runtime"                 # shared shinylive assets
)
```



# Add non-CRAN packages (i.e., Bioconductor pkgs)

Install pkgs into docs/runtime/webr/packages/

```{r install-packages-to-runtime, message=TRUE, warning=TRUE, eval=FALSE}
library("webr")
webr::install("sortable")
webr::global_prompt_install()

```


# Export all shinylive apps

```{r export-all-shinylive-apps, message=TRUE, warning=TRUE, eval=FALSE}
# List of app directories inside exported_shinyapps/
app_keys <- c("main_page", "taxonomy", "ordination", "statistics", "group_testing", "bfi")

# Export main_page → docs/index.html
shinylive::export(
  appdir     = file.path("exported_shinyapps", "main_page"),
  destdir    = ".",
  subdir     = NULL,
  assets_dir = "runtime"
)

# Export all other apps → docs/exported_shinyapps/<appname>/
for (app in app_keys[-1]) {
  message("Exporting: ", app)
  shinylive::export(
    appdir     = file.path("exported_shinyapps", app),
    destdir    = file.path("exported_shinyapps"),
    subdir     = app,
    assets_dir = "runtime"
  )
}
```




# How-To: Create Shiny Apps and Export via shinylive::export()

```{r install-shiny, include=FALSE,eval=FALSE}
install.packages("shinylive")
```

```{r load-shiny}
library("shinylive"); packageVersion("shinylive") # ‘0.3.0’
library("httpuv"); packageVersion("httpuv") # ‘1.6.16’
library("usethis"); packageVersion("usethis") # ‘3.1.0’
```

## Usage

source: <https://posit-dev.github.io/r-shinylive/>

To get started, we’ll create a basic shiny application in a new directory `myapp/`. If you have an existing Shiny application, you can skip this step and replace "myapp" with the path to your existing app.

```{r 0-example-copy-shinyapp, include=FALSE,eval=FALSE}
# Copy "Hello World" from `{shiny}`
system.file("examples", "01_hello", package="shiny") |>
    fs::dir_copy("myapp_helloworld", overwrite = TRUE)

#copy
system.file("examples", "01_hello", package="shiny") |>
    fs::dir_copy("app_dev/myapp_helloworld", overwrite = TRUE)

shinylive::export("app_dev/myapp_helloworld", "exported_shinyapps", subdir = "myapp_helloworld", assets_dir = "runtime")
```

Once you have a Shiny application in `myapp/` and would like turn it into a Shinylive app in `site/`:

```{r 0-example-export, eval=FALSE}
shinylive::export("myapp", "site")
```

At this point, you can deploy the `site/` directory to any static web hosting service.

Then you can preview the application by running a web server and visiting it in a browser:

```{r 0-example-preview, include=F,eval=FALSE}
httpuv::runStaticServer("site/")
```

\

## Multiple applications

If you have multiple applications that you want to put on the same site, you can export them to subdirectories of the site, so that they can all share the same Shinylive assets. You can do this with the `--subdir` option:

```{r 0-example-multiple-export, eval=FALSE}
shinylive::export("myapp1", "site", subdir = "app1")
shinylive::export("myapp2", "site", subdir = "app2")
```

## GitHub Pages

`posit-dev/r-shiny` has a workflow to automatically deploy your Shiny app from the root directory in your GitHub repository to its GitHub Pages. You can add this workflow to your repo with help from [usethis](https://usethis.r-lib.org/).

```{r use-github-action-to-deploy, eval=FALSE}
usethis::use_github_action(url="https://github.com/posit-dev/r-shinylive/blob/actions-v1/examples/deploy-app.yaml")
```

For more information, see the [examples folder](https://github.com/posit-dev/r-shinylive/tree/actions-v1/examples).

## **R package availability**

The [shinylive](https://posit-dev.github.io/r-shinylive/) web assets will statically inspect which packages are being used in your app.

If your app includes a package that is not automatically discovered, you can add an impossible-to-reach code within your Shiny application that has a library call to that R package. For example:

```         
if (FALSE) {
  library(HIDDEN_CRAN_PKG)
}
```

If you’d rather handle it manually, call `webr::install("CRAN_PKG")` in your Shiny application before calling [`library(CRAN_PKG)`](https://rdrr.io/r/base/library.html) or [`require("CRAN_PKG")`](https://rdrr.io/r/base/library.html).

If an R package has trouble loading, visit <https://repo.r-wasm.org/> to see if it is able to be installed as a precompiled WebAssembly binary.

> [Note from `{webr}`](https://docs.r-wasm.org/webr/latest/packages.html#building-r-packages-for-webr):\
> It is not possible to install packages from source in webR. This is not likely to change in the near future, as such a process would require an entire C and Fortran compiler toolchain to run inside the browser. For the moment, providing pre-compiled WebAssembly binaries is the only supported way to install R packages in webR.

## **Shinylive asset management**

Each version of the Shinylive R package is associated with a particular version of the Shinylive web assets. ([See the releases here](https://github.com/posit-dev/shinylive/releases).)

To see which version of this R package you have, and which version of the web assets it is associated with, simply run [`shinylive::assets_info()`](https://posit-dev.github.io/r-shinylive/reference/assets.html) in your R session. It will also show which asset versions you have already installed locally:

```         
shinylive::assets_info()
#> shinylive R package version:  0.1.0
#> shinylive web assets version: 0.2.1
#>
#> Local cached shinylive asset dir:
#>     /Users/username/Library/Caches/shinylive
#>
#> Installed assets:
#>     /Users/username/Library/Caches/shinylive/0.2.1
#>     /Users/username/Library/Caches/shinylive/0.2.0
```

```{r echo-shinylive-assets-info, eval=TRUE}
shinylive::assets_info()
# shinylive R package version: 0.3.0
# shinylive web assets version: 0.9.1
# 
# Local cached shinylive asset dir:
# → /Users/L347123/Library/Caches/shinylive
# 
# Installed assets:
# • '(None)'
# Error in x[[2]] : subscript out of bounds
```


The web assets will be downloaded and cached the first time you run [`shinylive::export()`](https://posit-dev.github.io/r-shinylive/reference/export.html). Or, you can run [`shinylive::assets_download()`](https://posit-dev.github.io/r-shinylive/reference/assets.html) to fetch them manually.

```         
shinylive::assets_download("0.1.5")
#> Downloading shinylive v0.1.5...
#> Unzipping to /Users/username/Library/Caches/shinylive/
```

You can remove old versions with [`shinylive::assets_cleanup()`](https://posit-dev.github.io/r-shinylive/reference/assets.html). This will remove all versions except the one that the Python package wants to use:

```         
shinylive::assets_cleanup()
#> Keeping version 0.2.1
#> Removing /Users/username/Library/Caches/shinylive/0.2.0
#> Removing /Users/username/Library/Caches/shinylive/0.1.5
```

To remove a specific version, use [`shinylive::assets_remove()`](https://posit-dev.github.io/r-shinylive/reference/assets.html):

```         
shinylive::assets_remove("0.2.1")
#> Removing /Users/username/Library/Caches/shinylive/0.2.1
```

## **Development**

### **Setup - shinylive assets**

Works with latest GitHub version of [`posit-dev/shinylive`](https://github.com/posit-dev/shinylive/) (\>= v`0.2.1`).

Before linking the shinylive assets to the asset cache folder, you must first build the shiny live assets:

```         
## In your shinylive assets repo
# cd PATH/TO/posit-dev/shinylive

# Generate the shiny live assets
make submodules all
```

Then link the assets (using the [shinylive](https://posit-dev.github.io/r-shinylive/) R package) to the asset cache folder so that changes to the assets are automatically in your cached shinylive assets:

```         
# Link to your local shinylive repo
shinylive::assets_install_link("PATH/TO/posit-dev/shinylive")
```

### **Execute - `export()`**

Export a local app to a directory and run it:

```         
library(httpuv) # >= 1.6.12
pkgload::load_all()

# Delete prior
unlink("local/shiny-apps-out/", recursive = TRUE)
export("local/shiny-apps/simple-r", "local/shiny-apps-out")

# Host the local directory
httpuv::runStaticServer("local/shiny-apps-out/")
```
